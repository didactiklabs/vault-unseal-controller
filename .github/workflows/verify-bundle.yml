name: Verify Manifests

on:
  pull_request:
    paths:
      - 'api/**'
      - 'config/**'
      - 'internal/controller/**'
      - 'deploy/bundle.yaml'

jobs:
  verify-bundle:
    name: Verify deploy/bundle.yaml is up-to-date
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Install controller-gen and kustomize
        run: |
          make controller-gen kustomize

      - name: Generate manifests
        run: |
          make manifests

      - name: Generate bundle
        run: |
          make bundle

      - name: Check for differences
        run: |
          if ! git diff --exit-code deploy/bundle.yaml; then
            echo "❌ Error: deploy/bundle.yaml is out of sync with the generated manifests!"
            echo ""
            echo "Please run the following commands locally and commit the changes:"
            echo "  make manifests"
            echo "  make bundle"
            echo ""
            echo "Differences found:"
            git diff deploy/bundle.yaml
            exit 1
          else
            echo "✅ deploy/bundle.yaml is up-to-date!"
          fi
